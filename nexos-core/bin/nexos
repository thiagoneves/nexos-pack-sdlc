#!/usr/bin/env bash
# nexos — AI Agent Framework CLI
# Version: 1.0.0

set -euo pipefail

NEXOS_VERSION="1.0.0"
NEXOS_HOME="${NEXOS_HOME:-$HOME/.nexos}"
NEXOS_LOCAL=".nexos"
CONFIG_FILE="$NEXOS_LOCAL/config.yaml"
LOCK_FILE="$NEXOS_LOCAL/lock.yaml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}[nexos]${NC} $1"; }
log_ok()    { echo -e "${GREEN}[nexos]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[nexos]${NC} $1"; }
log_error() { echo -e "${RED}[nexos]${NC} $1"; }

# ─── COMMANDS ────────────────────────────────────────────────────────────────

cmd_version() {
  echo "nexos v$NEXOS_VERSION"
}

cmd_help() {
  cat <<'HELP'
nexos — AI Agent Framework CLI

Usage: nexos <command> [options]

Commands:
  init --tool <tool>          Initialize project for an AI CLI tool
  install <repo>              Install a pack (resolves dependencies)
  remove <pack-name>          Remove an installed pack
  generate                    Regenerate tool-specific files from packs
  list                        List installed packs
  update                      Update all packs to latest version
  validate                    Validate pack files against schemas
  create-pack <name>          Create a new pack from template
  lock                        Show lock file status

Tools:
  claude-code                 Anthropic Claude Code
  gemini-cli                  Google Gemini CLI
  antigravity                 Google Antigravity

Features:
  Dependencies                Packs can declare dependencies on other packs
  Lock file                   .nexos/lock.yaml pins exact installed versions
  Hooks                       Packs can run scripts on install/generate/remove

Examples:
  nexos init --tool claude-code
  nexos install thiagoneves/nexos-pack-software-dev
  nexos install ./local-pack
  nexos generate
  nexos list
  nexos lock
HELP
}

# ─── INIT ────────────────────────────────────────────────────────────────────

cmd_init() {
  local tool=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --tool) tool="$2"; shift 2 ;;
      *) log_error "Unknown option: $1"; exit 1 ;;
    esac
  done

  if [[ -z "$tool" ]]; then
    log_error "Missing --tool option. Use: claude-code, gemini-cli, or antigravity"
    exit 1
  fi

  case "$tool" in
    claude-code|gemini-cli|antigravity) ;;
    *) log_error "Unknown tool: $tool. Use: claude-code, gemini-cli, or antigravity"; exit 1 ;;
  esac

  # Create local config directory
  mkdir -p "$NEXOS_LOCAL/packs"

  # Get project name from directory
  local project_name
  project_name=$(basename "$(pwd)")

  # Create config file
  cat > "$CONFIG_FILE" <<EOF
nexos:
  version: $NEXOS_VERSION
  tool: $tool

project:
  name: $project_name
  type: greenfield

packs: []
EOF

  # Generate AGENTS.md
  _generate_agents_md

  log_ok "Project initialized for $tool"
  log_info "Config: $CONFIG_FILE"
  log_info "Next: nexos install <pack-repo>"
}

# ─── INSTALL ─────────────────────────────────────────────────────────────────

_install_pack() {
  local source="$1"
  local depth="${2:-0}"

  local pack_dir=""
  local pack_name=""

  if [[ -d "$source" ]]; then
    # Local path
    pack_dir="$source"
    log_info "Installing from local path: $source"
  elif [[ "$source" == */* ]]; then
    # GitHub repo (user/repo format)
    pack_dir="$NEXOS_LOCAL/packs/_tmp_clone"
    rm -rf "$pack_dir"
    log_info "Cloning from GitHub: $source"
    git clone --depth 1 "https://github.com/$source.git" "$pack_dir" 2>/dev/null || {
      log_error "Failed to clone: $source"
      exit 1
    }
  else
    log_error "Invalid source: $source (use local path or user/repo)"
    exit 1
  fi

  # Validate pack
  if [[ ! -f "$pack_dir/pack.yaml" ]]; then
    log_error "No pack.yaml found in $pack_dir"
    exit 1
  fi

  # Extract pack name from pack.yaml
  pack_name=$(grep -m1 'name:' "$pack_dir/pack.yaml" | sed 's/.*name: *//' | tr -d '"' | tr -d "'")

  if [[ -z "$pack_name" ]]; then
    log_error "Could not read pack name from pack.yaml"
    exit 1
  fi

  # Copy pack to local packs directory
  local target="$NEXOS_LOCAL/packs/$pack_name"
  rm -rf "$target"
  cp -r "$pack_dir" "$target"

  # Clean up temp clone
  rm -rf "$NEXOS_LOCAL/packs/_tmp_clone"

  # Extract version
  local pack_version
  pack_version=$(grep -m1 'version:' "$target/pack.yaml" | sed 's/.*version: *//' | tr -d '"' | tr -d "'")

  # Update config.yaml — append pack entry
  local today
  today=$(date +%Y-%m-%d)

  # Check if pack already exists in config
  if grep -q "name: $pack_name" "$CONFIG_FILE" 2>/dev/null; then
    log_info "Updating existing pack entry: $pack_name"
    sed -i.bak "s/name: $pack_name/name: $pack_name/" "$CONFIG_FILE"
    rm -f "${CONFIG_FILE}.bak"
  else
    # Append new pack entry
    if grep -q 'packs: \[\]' "$CONFIG_FILE"; then
      sed -i.bak "s/packs: \[\]/packs:/" "$CONFIG_FILE"
      rm -f "${CONFIG_FILE}.bak"
    fi
    cat >> "$CONFIG_FILE" <<EOF
  - name: $pack_name
    repo: $source
    version: $pack_version
    installed: $today
EOF
  fi

  log_ok "Pack '$pack_name' v$pack_version installed"

  # Resolve dependencies (recursive)
  _resolve_dependencies "$target" "$source" "$depth"

  # Run post-install hook
  _run_hook "post-install" "$target"
}

cmd_install() {
  if [[ $# -eq 0 ]]; then
    log_error "Usage: nexos install <repo-or-path>"
    exit 1
  fi

  local source="$1"

  if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "No nexos config found. Run 'nexos init --tool <tool>' first."
    exit 1
  fi

  # Install the pack (and its dependencies)
  _install_pack "$source" 0

  # Write lock file
  _lock_write

  # Auto-generate tool files
  cmd_generate
}

# ─── GENERATE ────────────────────────────────────────────────────────────────

cmd_generate() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "No nexos config found. Run 'nexos init --tool <tool>' first."
    exit 1
  fi

  local tool
  tool=$(grep 'tool:' "$CONFIG_FILE" | head -1 | sed 's/.*tool: *//' | tr -d '"' | tr -d "'")

  log_info "Generating files for: $tool"

  # Always generate AGENTS.md
  _generate_agents_md

  # Run tool-specific adapter
  local adapter_script="$NEXOS_HOME/adapters/$tool/generate.sh"
  if [[ -f "$adapter_script" ]]; then
    bash "$adapter_script" "$(pwd)"
  else
    # Try local nexos repo adapters
    local local_adapter
    local_adapter=$(find . -path "*/nexos/adapters/$tool/generate.sh" -not -path "*/.nexos/*" 2>/dev/null | head -1)
    if [[ -n "$local_adapter" ]]; then
      bash "$local_adapter" "$(pwd)"
    else
      log_warn "Adapter not found for $tool. Running built-in generator."
      _builtin_generate "$tool"
    fi
  fi

  # Run post-generate hooks for all packs
  local packs_dir="$NEXOS_LOCAL/packs"
  if [[ -d "$packs_dir" ]]; then
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue
      _run_hook "post-generate" "$pack_dir"
    done
  fi

  log_ok "Files generated for $tool"
}

# ─── Built-in generator (fallback) ──────────────────────────────────────────

_builtin_generate() {
  local tool="$1"

  case "$tool" in
    claude-code)  _generate_claude_code ;;
    gemini-cli)   _generate_gemini_cli ;;
    antigravity)  _generate_antigravity ;;
  esac
}

_generate_claude_code() {
  mkdir -p .claude/rules

  local claude_md=".claude/CLAUDE.md"
  local packs_dir="$NEXOS_LOCAL/packs"

  # Start CLAUDE.md
  cat > "$claude_md" <<'HEADER'
# nexos Development Rules for Claude Code

> Auto-generated by nexos. Do not edit manually — run `nexos generate` to update.

## Agent System

### Activation
- Agents are activated with @agent-name syntax
- Agent commands use the * prefix: *help, *develop, *validate, *exit
- When an agent is active, read its full definition file and follow its instructions

### Agent Context
When an agent is active:
- Read the agent file from `.nexos/packs/<pack>/agents/<id>.md`
- Follow the agent's persona, principles, and authority
- Only execute commands listed in the agent's Commands section
- Respect authority boundaries (Allowed vs Blocked operations)

HEADER

  # List maintenance agents
  cat >> "$claude_md" <<'MAINTENANCE'
### Maintenance Agents (nexos core)
- @skill-creator — Creates agents, tasks, and skills
- @squad-creator — Creates team compositions
- @pack-creator — Scaffolds new packs
- @schema-validator — Validates files against schemas

MAINTENANCE

  # Add agents from all installed packs
  if [[ -d "$packs_dir" ]]; then
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue

      echo "### Pack: $pname" >> "$claude_md"
      echo "" >> "$claude_md"

      # List pack agents
      if [[ -d "$pack_dir/agents" ]]; then
        echo "**Agents:**" >> "$claude_md"
        for agent_file in "$pack_dir"/agents/*.md; do
          [[ -f "$agent_file" ]] || continue
          local aid atitle awhen
          aid=$(grep -m1 '^id:' "$agent_file" | sed 's/id: *//' | tr -d '"' | tr -d "'")
          atitle=$(grep -m1 '^title:' "$agent_file" | sed 's/title: *//' | tr -d '"' | tr -d "'")
          if [[ -n "$aid" && -n "$atitle" ]]; then
            echo "- @$aid — $atitle" >> "$claude_md"
          fi
        done
        echo "" >> "$claude_md"
      fi

      # List pack workflows
      if [[ -d "$pack_dir/workflows" ]]; then
        echo "**Workflows:**" >> "$claude_md"
        for wf_file in "$pack_dir"/workflows/*.yaml; do
          [[ -f "$wf_file" ]] || continue
          local wname
          wname=$(grep -m1 'name:' "$wf_file" | sed 's/.*name: *//' | tr -d '"' | tr -d "'")
          [[ -n "$wname" ]] && echo "- $wname" >> "$claude_md"
        done
        echo "" >> "$claude_md"
      fi

      # Copy rules
      if [[ -d "$pack_dir/rules" ]]; then
        for rule_file in "$pack_dir"/rules/*.md; do
          [[ -f "$rule_file" ]] || continue
          cp "$rule_file" ".claude/rules/"
        done
      fi
    done
  fi

  # Framework structure section
  cat >> "$claude_md" <<'STRUCTURE'
## Framework Structure

```
.nexos/
  config.yaml          # Project configuration
  packs/               # Installed packs
    <pack-name>/
      agents/          # Agent definitions
      tasks/           # Task instructions
      workflows/       # Workflow definitions
      templates/       # File templates
      rules/           # Rule files
```

## Task Execution

When a command like `*develop` is invoked:
1. Identify the correct task file from the active pack
2. Read the full task file
3. Follow the Steps section sequentially
4. Handle errors as described in the Error Handling section
5. Report results to the user

## Tool Priority

| Task | Use This | Not This |
|------|----------|----------|
| Read files | Read tool | cat/head/tail |
| Search content | Grep tool | grep/rg in bash |
| Write files | Write/Edit tools | echo/cat |
| Search files | Glob tool | find |
STRUCTURE

  log_info "  Generated: $claude_md"
  log_info "  Rules copied to: .claude/rules/"
}

_generate_gemini_cli() {
  mkdir -p .gemini

  local gemini_md="GEMINI.md"
  local packs_dir="$NEXOS_LOCAL/packs"

  cat > "$gemini_md" <<'HEADER'
# nexos Development Rules

> Auto-generated by nexos. Do not edit manually — run `nexos generate` to update.

## Agent System

Agents are activated with @agent-name syntax. Commands use the * prefix.
When an agent is active, read its definition from `.nexos/packs/<pack>/agents/<id>.md`.

HEADER

  # Add agents from packs
  if [[ -d "$packs_dir" ]]; then
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue

      echo "## Pack: $pname" >> "$gemini_md"
      echo "" >> "$gemini_md"

      if [[ -d "$pack_dir/agents" ]]; then
        for agent_file in "$pack_dir"/agents/*.md; do
          [[ -f "$agent_file" ]] || continue
          local aid atitle
          aid=$(grep -m1 '^id:' "$agent_file" | sed 's/id: *//' | tr -d '"' | tr -d "'")
          atitle=$(grep -m1 '^title:' "$agent_file" | sed 's/title: *//' | tr -d '"' | tr -d "'")
          [[ -n "$aid" && -n "$atitle" ]] && echo "- @$aid — $atitle" >> "$gemini_md"
        done
        echo "" >> "$gemini_md"
      fi

      # Import rules
      if [[ -d "$pack_dir/rules" ]]; then
        for rule_file in "$pack_dir"/rules/*.md; do
          [[ -f "$rule_file" ]] || continue
          echo "@$rule_file" >> "$gemini_md"
        done
        echo "" >> "$gemini_md"
      fi
    done
  fi

  # Gemini settings
  cat > ".gemini/settings.json" <<EOF
{
  "context": {
    "fileName": ["AGENTS.md", "GEMINI.md"]
  }
}
EOF

  log_info "  Generated: $gemini_md"
  log_info "  Generated: .gemini/settings.json"
}

_generate_antigravity() {
  mkdir -p .agent/rules .agent/skills .agent/workflows

  local packs_dir="$NEXOS_LOCAL/packs"
  local rules_content=""

  if [[ -d "$packs_dir" ]]; then
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue

      # Merge rules into single rules.md
      if [[ -d "$pack_dir/rules" ]]; then
        for rule_file in "$pack_dir"/rules/*.md; do
          [[ -f "$rule_file" ]] || continue
          rules_content+="$(cat "$rule_file")"$'\n\n'
        done
      fi

      # Create skill per agent
      if [[ -d "$pack_dir/agents" ]]; then
        for agent_file in "$pack_dir"/agents/*.md; do
          [[ -f "$agent_file" ]] || continue
          local aid
          aid=$(grep -m1 '^id:' "$agent_file" | sed 's/id: *//' | tr -d '"' | tr -d "'")
          if [[ -n "$aid" ]]; then
            mkdir -p ".agent/skills/$aid"
            cp "$agent_file" ".agent/skills/$aid/SKILL.md"
          fi
        done
      fi

      # Create workflow files
      if [[ -d "$pack_dir/workflows" ]]; then
        for wf_file in "$pack_dir"/workflows/*.yaml; do
          [[ -f "$wf_file" ]] || continue
          local wf_base
          wf_base=$(basename "$wf_file" .yaml)
          cp "$wf_file" ".agent/workflows/$wf_base.md"
        done
      fi
    done
  fi

  # Write merged rules
  if [[ -n "$rules_content" ]]; then
    echo "$rules_content" > ".agent/rules/rules.md"
  fi

  log_info "  Generated: .agent/rules/rules.md"
  log_info "  Generated: .agent/skills/*"
  log_info "  Generated: .agent/workflows/*"
}

# ─── AGENTS.MD (Universal) ──────────────────────────────────────────────────

_generate_agents_md() {
  local agents_md="AGENTS.md"
  local project_name
  project_name=$(basename "$(pwd)")

  cat > "$agents_md" <<EOF
# $project_name

> Auto-generated by nexos v$NEXOS_VERSION. Do not edit manually.

## Overview

This project uses **nexos** for AI agent orchestration.

## Installed Packs

EOF

  local packs_dir="$NEXOS_LOCAL/packs"
  if [[ -d "$packs_dir" ]]; then
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue

      local pdesc=""
      if [[ -f "$pack_dir/pack.yaml" ]]; then
        pdesc=$(grep -m1 'description:' "$pack_dir/pack.yaml" | sed 's/.*description: *//' | tr -d '"' | tr -d "'")
      fi

      echo "### $pname" >> "$agents_md"
      [[ -n "$pdesc" ]] && echo "$pdesc" >> "$agents_md"
      echo "" >> "$agents_md"

      if [[ -d "$pack_dir/agents" ]]; then
        echo "**Agents:**" >> "$agents_md"
        for agent_file in "$pack_dir"/agents/*.md; do
          [[ -f "$agent_file" ]] || continue
          local aid atitle
          aid=$(grep -m1 '^id:' "$agent_file" | sed 's/id: *//' | tr -d '"' | tr -d "'")
          atitle=$(grep -m1 '^title:' "$agent_file" | sed 's/title: *//' | tr -d '"' | tr -d "'")
          [[ -n "$aid" && -n "$atitle" ]] && echo "- @$aid — $atitle" >> "$agents_md"
        done
        echo "" >> "$agents_md"
      fi
    done
  else
    echo "No packs installed yet. Run \`nexos install <pack>\` to add one." >> "$agents_md"
  fi
}

# ─── LIST ────────────────────────────────────────────────────────────────────

cmd_list() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "No nexos config found. Run 'nexos init --tool <tool>' first."
    exit 1
  fi

  local tool
  tool=$(grep 'tool:' "$CONFIG_FILE" | head -1 | sed 's/.*tool: *//' | tr -d '"' | tr -d "'")

  echo -e "${CYAN}nexos v$NEXOS_VERSION${NC} (tool: $tool)"
  echo ""

  local packs_dir="$NEXOS_LOCAL/packs"
  if [[ -d "$packs_dir" ]] && [ "$(ls -A "$packs_dir" 2>/dev/null)" ]; then
    echo "Installed packs:"
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname pver
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue
      pver=$(grep -m1 'version:' "$pack_dir/pack.yaml" 2>/dev/null | sed 's/.*version: *//' | tr -d '"' | tr -d "'")
      local agent_count
      agent_count=$(find "$pack_dir/agents" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
      local task_count
      task_count=$(find "$pack_dir/tasks" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
      echo -e "  ${GREEN}$pname${NC} v${pver:-?} ($agent_count agents, $task_count tasks)"
    done
  else
    echo "No packs installed."
    echo "Run: nexos install <user/repo>"
  fi
}

# ─── REMOVE ──────────────────────────────────────────────────────────────────

cmd_remove() {
  local pack_name="$1"
  local pack_dir="$NEXOS_LOCAL/packs/$pack_name"

  if [[ ! -d "$pack_dir" ]]; then
    log_error "Pack '$pack_name' is not installed."
    exit 1
  fi

  # Check if other packs depend on this one
  for other_dir in "$NEXOS_LOCAL/packs"/*/; do
    [[ -d "$other_dir" ]] || continue
    local other_name
    other_name=$(basename "$other_dir")
    [[ "$other_name" == "$pack_name" || "$other_name" == "_tmp_clone" ]] && continue

    if grep -q "name: $pack_name" "$other_dir/pack.yaml" 2>/dev/null; then
      local in_deps
      in_deps=$(awk '/dependencies:/,/^  [a-z]/' "$other_dir/pack.yaml" 2>/dev/null | grep -c "name: $pack_name" || true)
      if [[ "$in_deps" -gt 0 ]]; then
        log_warn "Pack '$other_name' depends on '$pack_name'."
        log_error "Remove '$other_name' first, or use --force."
        if [[ "${2:-}" != "--force" ]]; then
          exit 1
        fi
      fi
    fi
  done

  # Run pre-remove hook
  _run_hook "pre-remove" "$pack_dir"

  rm -rf "$pack_dir"
  log_ok "Pack '$pack_name' removed."

  # Update lock file
  _lock_write

  # Regenerate files
  cmd_generate
}

# ─── UPDATE ──────────────────────────────────────────────────────────────────

cmd_update() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "No nexos config found."
    exit 1
  fi

  log_info "Updating packs..."

  local packs_dir="$NEXOS_LOCAL/packs"
  # For local packs, just regenerate. For remote, re-clone would need repo info.
  # For now, just regenerate.
  cmd_generate

  log_ok "Packs updated."
}

# ─── VALIDATE ────────────────────────────────────────────────────────────────

cmd_validate() {
  local packs_dir="$NEXOS_LOCAL/packs"
  local errors=0

  if [[ ! -d "$packs_dir" ]]; then
    log_error "No packs installed."
    exit 1
  fi

  for pack_dir in "$packs_dir"/*/; do
    [[ -d "$pack_dir" ]] || continue
    local pname
    pname=$(basename "$pack_dir")
    [[ "$pname" == "_tmp_clone" ]] && continue

    log_info "Validating pack: $pname"

    # Check pack.yaml
    if [[ ! -f "$pack_dir/pack.yaml" ]]; then
      log_error "  Missing pack.yaml"
      ((errors++))
      continue
    fi

    # Check agents
    if [[ -d "$pack_dir/agents" ]]; then
      for agent_file in "$pack_dir"/agents/*.md; do
        [[ -f "$agent_file" ]] || continue
        local fname
        fname=$(basename "$agent_file")

        # Check required frontmatter fields
        if ! grep -q '^id:' "$agent_file"; then
          log_error "  $fname: missing 'id' in frontmatter"
          ((errors++))
        fi
        if ! grep -q '^title:' "$agent_file"; then
          log_error "  $fname: missing 'title' in frontmatter"
          ((errors++))
        fi

        # Check required sections
        for section in "## Role" "## Core Principles" "## Commands" "## Authority"; do
          if ! grep -q "$section" "$agent_file"; then
            log_error "  $fname: missing section '$section'"
            ((errors++))
          fi
        done

        # Check required commands
        if ! grep -q '\*help' "$agent_file"; then
          log_warn "  $fname: missing *help command"
        fi
        if ! grep -q '\*exit' "$agent_file"; then
          log_warn "  $fname: missing *exit command"
        fi
      done
    fi

    # Check tasks
    if [[ -d "$pack_dir/tasks" ]]; then
      for task_file in "$pack_dir"/tasks/*.md; do
        [[ -f "$task_file" ]] || continue
        local fname
        fname=$(basename "$task_file")

        if ! grep -q '^task:' "$task_file"; then
          log_error "  $fname: missing 'task' in frontmatter"
          ((errors++))
        fi

        for section in "## Purpose" "## Steps"; do
          if ! grep -q "$section" "$task_file"; then
            log_error "  $fname: missing section '$section'"
            ((errors++))
          fi
        done
      done
    fi

    log_ok "  Pack '$pname' validated"
  done

  if [[ $errors -gt 0 ]]; then
    log_error "Validation found $errors error(s)"
    exit 1
  else
    log_ok "All packs valid"
  fi
}

# ─── CREATE-PACK ─────────────────────────────────────────────────────────────

cmd_create_pack() {
  local name="$1"

  if [[ -d "$name" ]]; then
    log_error "Directory '$name' already exists."
    exit 1
  fi

  # Find pack template
  local template_dir="$NEXOS_HOME/templates/pack"
  if [[ ! -d "$template_dir" ]]; then
    # Try local nexos repo
    template_dir=$(find . -path "*/nexos/templates/pack" -not -path "*/.nexos/*" 2>/dev/null | head -1)
  fi

  if [[ -n "$template_dir" && -d "$template_dir" ]]; then
    cp -r "$template_dir" "$name"
  else
    # Create from scratch
    mkdir -p "$name"/{agents,tasks,workflows,templates,rules}
  fi

  # Generate pack.yaml
  cat > "$name/pack.yaml" <<EOF
pack:
  name: $name
  version: 0.1.0
  description: >
    Description of your pack.
  author: $(whoami)
  domain: custom
  license: MIT

  agents: []
  tasks: []
  workflows: []
  templates: []
  rules: []

  config: {}
EOF

  # Generate README
  cat > "$name/README.md" <<EOF
# $name

A nexos pack.

## Installation

\`\`\`bash
nexos install ./$name
\`\`\`

## Agents

_Add agent descriptions here._

## Workflows

_Add workflow descriptions here._
EOF

  log_ok "Pack '$name' created."
  log_info "Edit $name/pack.yaml to configure, then add agents, tasks, and workflows."
}

# ─── LOCK ────────────────────────────────────────────────────────────────────

cmd_lock() {
  if [[ ! -f "$LOCK_FILE" ]]; then
    log_warn "No lock file found. Run 'nexos install' to generate one."
    return
  fi

  echo -e "${CYAN}Lock file: $LOCK_FILE${NC}"
  echo ""
  cat "$LOCK_FILE"
  echo ""

  if _lock_verify 2>/dev/null; then
    log_ok "All packs match lock file."
  else
    log_warn "Some packs differ from lock file. Run 'nexos install' to update."
  fi
}

# ─── LOCK FILE ──────────────────────────────────────────────────────────────

_lock_write() {
  local packs_dir="$NEXOS_LOCAL/packs"

  cat > "$LOCK_FILE" <<EOF
# nexos lock file — auto-generated, do not edit manually
# Run 'nexos install' to regenerate
lockVersion: 1
generatedAt: $(date -u +%Y-%m-%dT%H:%M:%SZ)
nexosVersion: $NEXOS_VERSION
packs:
EOF

  if [[ -d "$packs_dir" ]]; then
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname pver pdomain
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue
      pver=$(grep -m1 'version:' "$pack_dir/pack.yaml" 2>/dev/null | sed 's/.*version: *//' | tr -d '"' | tr -d "'")
      pdomain=$(grep -m1 'domain:' "$pack_dir/pack.yaml" 2>/dev/null | sed 's/.*domain: *//' | tr -d '"' | tr -d "'")

      # Get repo from config if available
      local prepo=""
      if [[ -f "$CONFIG_FILE" ]]; then
        prepo=$(awk "/name: $pname/{found=1} found && /repo:/{print; exit}" "$CONFIG_FILE" | sed 's/.*repo: *//' | tr -d '"' | tr -d "'" || true)
      fi

      # Get git commit hash if available
      local pcommit="unknown"
      if [[ -d "$pack_dir/.git" ]]; then
        pcommit=$(git -C "$pack_dir" rev-parse --short HEAD 2>/dev/null || echo "unknown")
      fi

      cat >> "$LOCK_FILE" <<EOF
  $pname:
    version: ${pver:-0.0.0}
    domain: ${pdomain:-unknown}
    repo: ${prepo:-local}
    commit: $pcommit
    installedAt: $(date -u +%Y-%m-%dT%H:%M:%SZ)
EOF

      # Write dependencies if present
      local has_deps
      has_deps=$(awk '/^  dependencies:/,/^  [a-z]/' "$pack_dir/pack.yaml" 2>/dev/null | grep -c 'name:' || true)
      if [[ "$has_deps" -gt 0 ]]; then
        echo "    dependencies:" >> "$LOCK_FILE"
        awk '/^  dependencies:/,/^  [a-z]/' "$pack_dir/pack.yaml" 2>/dev/null | grep 'name:' | while read -r line; do
          local depname
          depname=$(echo "$line" | sed 's/.*name: *//' | tr -d '"' | tr -d "'")
          echo "      - $depname" >> "$LOCK_FILE"
        done
      fi
    done
  fi
}

_lock_verify() {
  if [[ ! -f "$LOCK_FILE" ]]; then
    return 0
  fi

  local packs_dir="$NEXOS_LOCAL/packs"
  local mismatches=0

  if [[ -d "$packs_dir" ]]; then
    for pack_dir in "$packs_dir"/*/; do
      [[ -d "$pack_dir" ]] || continue
      local pname pver
      pname=$(basename "$pack_dir")
      [[ "$pname" == "_tmp_clone" ]] && continue
      pver=$(grep -m1 'version:' "$pack_dir/pack.yaml" 2>/dev/null | sed 's/.*version: *//' | tr -d '"' | tr -d "'")

      local locked_ver
      locked_ver=$(awk "/$pname:/{found=1} found && /version:/{print; exit}" "$LOCK_FILE" | sed 's/.*version: *//' | tr -d '"' | tr -d "'" || true)

      if [[ -n "$locked_ver" && "$locked_ver" != "$pver" ]]; then
        log_warn "Pack '$pname': installed v$pver differs from locked v$locked_ver"
        ((mismatches++))
      fi
    done
  fi

  return $mismatches
}

# ─── DEPENDENCIES ───────────────────────────────────────────────────────────

_resolve_dependencies() {
  local pack_dir="$1"
  local source="$2"
  local depth="${3:-0}"

  if [[ $depth -gt 10 ]]; then
    log_error "Dependency depth exceeded (max 10). Possible circular dependency."
    exit 1
  fi

  # Check if pack.yaml has dependencies section
  if ! grep -q '^  dependencies:' "$pack_dir/pack.yaml" 2>/dev/null; then
    return 0
  fi

  # Parse dependencies
  local in_deps=false
  local dep_name="" dep_repo="" dep_version=""

  while IFS= read -r line; do
    # Detect start of dependencies block
    if [[ "$line" =~ ^[[:space:]]*dependencies: ]]; then
      in_deps=true
      continue
    fi

    # Exit dependencies block when hitting next top-level key
    if $in_deps && [[ "$line" =~ ^[[:space:]]{2}[a-z] && ! "$line" =~ ^[[:space:]]{4} ]]; then
      break
    fi

    if $in_deps; then
      if [[ "$line" =~ name:[[:space:]]*(.*) ]]; then
        dep_name=$(echo "${BASH_REMATCH[1]}" | tr -d '"' | tr -d "'" | xargs)
      fi
      if [[ "$line" =~ repo:[[:space:]]*(.*) ]]; then
        dep_repo=$(echo "${BASH_REMATCH[1]}" | tr -d '"' | tr -d "'" | xargs)
      fi
      if [[ "$line" =~ version:[[:space:]]*(.*) ]]; then
        dep_version=$(echo "${BASH_REMATCH[1]}" | tr -d '"' | tr -d "'" | xargs)
      fi

      # When we have a complete dependency entry, install it
      if [[ -n "$dep_name" && -n "$dep_repo" ]]; then
        if [[ -d "$NEXOS_LOCAL/packs/$dep_name" ]]; then
          log_info "Dependency '$dep_name' already installed, skipping."
        else
          log_info "Installing dependency: $dep_name (from $dep_repo)"
          _install_pack "$dep_repo" $((depth + 1))
        fi
        dep_name="" dep_repo="" dep_version=""
      fi
    fi
  done < "$pack_dir/pack.yaml"
}

# ─── HOOKS ──────────────────────────────────────────────────────────────────

_run_hook() {
  local hook_name="$1"
  local pack_dir="$2"

  if [[ ! -f "$pack_dir/pack.yaml" ]]; then
    return 0
  fi

  # Extract hook command from pack.yaml
  local hook_cmd=""
  hook_cmd=$(awk "/hooks:/,/^  [a-z]/" "$pack_dir/pack.yaml" 2>/dev/null | grep "$hook_name:" | sed "s/.*$hook_name: *//" | tr -d '"' | tr -d "'" || true)

  if [[ -n "$hook_cmd" ]]; then
    log_info "Running hook '$hook_name' for $(basename "$pack_dir")..."
    if (cd "$pack_dir" && bash -c "$hook_cmd"); then
      log_ok "Hook '$hook_name' completed."
    else
      log_warn "Hook '$hook_name' failed (exit $?)."
    fi
  fi
}

# ─── MAIN ────────────────────────────────────────────────────────────────────

main() {
  if [[ $# -eq 0 ]]; then
    cmd_help
    exit 0
  fi

  local command="$1"
  shift

  case "$command" in
    init)         cmd_init "$@" ;;
    install)      cmd_install "$@" ;;
    remove)       cmd_remove "$@" ;;
    generate)     cmd_generate ;;
    list)         cmd_list ;;
    update)       cmd_update ;;
    validate)     cmd_validate ;;
    create-pack)  cmd_create_pack "$@" ;;
    lock)         cmd_lock ;;
    version|--version|-v) cmd_version ;;
    help|--help|-h) cmd_help ;;
    *) log_error "Unknown command: $command"; cmd_help; exit 1 ;;
  esac
}

main "$@"
