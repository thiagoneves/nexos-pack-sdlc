#!/usr/bin/env bash
# Claude Code Adapter — Generates .claude/ files from installed packs
# Usage: bash generate.sh <project-root>

set -euo pipefail

PROJECT_ROOT="${1:-.}"
NEXOS_LOCAL="$PROJECT_ROOT/.nexos"
PACKS_DIR="$NEXOS_LOCAL/packs"

mkdir -p "$PROJECT_ROOT/.claude/rules"

CLAUDE_MD="$PROJECT_ROOT/.claude/CLAUDE.md"

# ─── Generate CLAUDE.md ─────────────────────────────────────────────────────

cat > "$CLAUDE_MD" <<'HEADER'
# nexos Development Rules for Claude Code

> Auto-generated by nexos. Do not edit manually — run `nexos generate` to update.

## Agent System

### Activation
- Agents are activated with @agent-name syntax
- Agent commands use the * prefix: *help, *develop, *validate, *exit
- When an agent is active, read its full definition file and follow its instructions

### Agent Context
When an agent is active:
- Read the agent file from `.nexos/packs/<pack>/agents/<id>.md`
- Follow the agent's persona, principles, and authority
- Only execute commands listed in the agent's Commands section
- Respect authority boundaries (Allowed vs Blocked operations)

### Maintenance Agents (nexos core)
- @skill-creator — Creates agents, tasks, and skills
- @squad-creator — Creates team compositions
- @pack-creator — Scaffolds new packs
- @schema-validator — Validates files against schemas

HEADER

# ─── Add pack agents and workflows ──────────────────────────────────────────

if [[ -d "$PACKS_DIR" ]]; then
  for pack_dir in "$PACKS_DIR"/*/; do
    [[ -d "$pack_dir" ]] || continue
    pname=$(basename "$pack_dir")
    [[ "$pname" == "_tmp_clone" ]] && continue

    echo "### Pack: $pname" >> "$CLAUDE_MD"
    echo "" >> "$CLAUDE_MD"

    # List agents
    if [[ -d "$pack_dir/agents" ]]; then
      echo "**Agents:**" >> "$CLAUDE_MD"
      for agent_file in "$pack_dir"/agents/*.md; do
        [[ -f "$agent_file" ]] || continue
        aid=$(grep -m1 '^id:' "$agent_file" | sed 's/id: *//' | tr -d '"' | tr -d "'")
        atitle=$(grep -m1 '^title:' "$agent_file" | sed 's/title: *//' | tr -d '"' | tr -d "'")
        [[ -n "$aid" && -n "$atitle" ]] && echo "- @$aid — $atitle" >> "$CLAUDE_MD"
      done
      echo "" >> "$CLAUDE_MD"
    fi

    # List workflows
    if [[ -d "$pack_dir/workflows" ]]; then
      echo "**Workflows:**" >> "$CLAUDE_MD"
      for wf_file in "$pack_dir"/workflows/*.yaml; do
        [[ -f "$wf_file" ]] || continue
        wname=$(grep -m1 'name:' "$wf_file" | sed 's/.*name: *//' | tr -d '"' | tr -d "'")
        [[ -n "$wname" ]] && echo "- $wname" >> "$CLAUDE_MD"
      done
      echo "" >> "$CLAUDE_MD"
    fi

    # Copy rules
    if [[ -d "$pack_dir/rules" ]]; then
      for rule_file in "$pack_dir"/rules/*.md; do
        [[ -f "$rule_file" ]] || continue
        cp "$rule_file" "$PROJECT_ROOT/.claude/rules/"
      done
    fi
  done
fi

# ─── Framework structure ────────────────────────────────────────────────────

cat >> "$CLAUDE_MD" <<'STRUCTURE'
## Framework Structure

```
.nexos/
  config.yaml          # Project configuration
  packs/               # Installed packs
    <pack-name>/
      agents/          # Agent definitions
      tasks/           # Task instructions
      workflows/       # Workflow definitions
      templates/       # File templates
      rules/           # Rule files
```

## Task Execution

When a command like `*develop` is invoked:
1. Identify the correct task file from the active pack
2. Read the full task file
3. Follow the Steps section sequentially
4. Handle errors as described in the Error Handling section
5. Report results to the user

## Tool Priority

| Task | Use This | Not This |
|------|----------|----------|
| Read files | Read tool | cat/head/tail |
| Search content | Grep tool | grep/rg in bash |
| Write files | Write/Edit tools | echo/cat |
| Search files | Glob tool | find |
STRUCTURE

echo "[nexos] Generated: $CLAUDE_MD"
echo "[nexos] Rules copied to: $PROJECT_ROOT/.claude/rules/"
